<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: /Users/ozum/Documents/DATA/WORK/Projects/Node/pg-test-util/lib/pg-test-util.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"PostgreSQL Test Utilities","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">PostgreSQL Test Utilities</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="PgTestUtil">
            <span class="title">
                <a href="PgTestUtil.html">PgTestUtil</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="PgTestUtil#createDB"><a href="PgTestUtil.html#createDB">createDB</a></li>
            
                <li data-name="PgTestUtil#dropDB"><a href="PgTestUtil.html#dropDB">dropDB</a></li>
            
                <li data-name="PgTestUtil#executeSQL"><a href="PgTestUtil.html#executeSQL">executeSQL</a></li>
            
                <li data-name="PgTestUtil#executeSQLFile"><a href="PgTestUtil.html#executeSQLFile">executeSQLFile</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="-_Users_ozum_Documents_DATA_WORK_Projects_Node_pg-test-util_lib_pg-test-util.js.html">Source: /Users/ozum/Documents/DATA/WORK/Projects/Node/pg-test-util/lib/pg-test-util.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>"use strict";
var optional    = require('optional'),
    pgNative    = optional('pg-native'),
    pg          = pgNative ? require('pg').native : require('pg'),
    fs          = require('fs'),
    path        = require('path'),
    lodash      = require('lodash');

//pg.on('error', function (err) {
//    // Do nothing on termination due to admin command. We do this to drop previously created test db.
//    if (!err.message.match('terminating connection due to administrator command')) { console.log('Database error: ', err); }
//});

/**
 * Helper class and methods to use in tests using PostgreSQL database. Primary focus of this class is not speed.
 * First priority is given to do operations such as create database, drop database etc. As a result this class
 * connects to database, runs query and then simply disconnects for every query in an inefficient way to prevent
 * further tests stopped by connection or access by others errors.
 *
 * PostgreSQL needs a database name for every connection, even for creating a new database, user have to connect
 * another database. This library accepts "connectionDatabase" parameter for the name of this database for creating
 * and/or dropping databases.
 *
 * It may not best method, but it is suggested to use credentials of a PostgreSQL user which has database create
 * and drop privileges and connect to "template1" database.
 *
 * @example
 * var PgTestUtil = require('pg-test-util');
 * var pgUtil = new PgTestUtil({
 *     user             : 'user',
 *     password         : 'password',
 *     defaultDatabase  : 'db-name'
 * });
 *
 * // Using function in promises
 *
 * pgUtil.createDB('testdb', { drop: true })
 * .then(function() { return pgUtil.createDB('testdb2', { drop: true }) })
 * .then(function() { return pgUtil.dropDB('testdb') })
 * .catch(function(err) { console.log(err); });
 *
 * // Using binded functions in promises
 *
 * pgUtil.createDB('testdb', { drop: true })
 * .then(pgUtil.createDB.bind(pgUtil, 'testdb2', { drop: true }))
 * .then(pgUtil.dropDB.bind(pgUtil, 'deneme'))
 * .catch(function(err) { console.log(err); });
 */
class PgTestUtil {
    /**
     * @param {string}  [dbConfig.user=postgres]                    - User name
     * @param {string}  [dbConfig.password]                         - DB Password
     * @param {string}  [dbConfig.host=localhost]                   - Host name
     * @param {number}  [dbConfig.port=5432]                        - Port number
     * @param {string}  [dbConfig.defaultDatabase]                  - Default database name to connect fro queries if no db is given.
     * @param {string}  [dbConfig.connectionDatabase=template1]     - Database name to connect to execute createDB and dropDB functions.
     *                                                                Every connection needs a database to connect even for creating a new database.
     */
    constructor(dbConfig) {
        this.dbConfig                       = {};
        this.dbConfig.user                  = dbConfig.user     || 'postgres';
        this.dbConfig.password              = dbConfig.password;
        this.dbConfig.host                  = dbConfig.host     || 'localhost';
        this.dbConfig.port                  = dbConfig.port     || 5432;
        this.dbConfig.defaultDatabase       = dbConfig.defaultDatabase;
        this.dbConfig.connectionDatabase    = dbConfig.connectionDatabase || 'template1';
    }

    /**
     * Executes single SQL. If result is successful calls success callback, if
     * result is failure calls fail callback.
     * @param {pg.Client}   client                      - PG client object to execute SQL
     * @param {string}      sql                         - SQL query to execute
     * @returns {Promise}
     * @private
     */
    _singleSQL(client, sql) {
        return new Promise((resolve, reject) => {
            //console.log("Executing SQL: " + sql);
            client.query(sql, function (err, result) {
                if (err) {
                    reject(err);
                } else {
                    resolve(result);
                }
            })
        });
    }

    /**
     * Connects to database, executes a single SQL query or a series of SQL queries against given databse,
     * then disconnects from it.
     * @param {string|Array.&lt;string>}   sql     - SQL query or array of SQL queries to execute.
     * @param {string}                  [db]    - Database name to query against. Uses default value from configuration if no value is given.
     * @returns {Promise.&lt;T>}
     */
    executeSQL(sql, db) {
        db = db || this.dbConfig.defaultDatabase;
        if (!db) {
            throw new Error('db parameter for database name is required.');
        }

        let    client  = new pg.Client(lodash.defaults({ database: db }, this.dbConfig)),
            pro     = [];

        // Convert SQL into array if it is a string.
        if (typeof sql === 'string') {
            sql = [sql];
        }

        // Create a promise for connecting client.
        pro[0] = new Promise((resolve, reject) => {
            client.connect(function(err) {
                if (err) {
                    reject(err);
                } else {
                    resolve();
                }
            });
        });

        // Execute given SQL queries by adding then blocks.
        for (let i = 0; i &lt; sql.length; i = i + 1) {
            pro[i+1] = pro[i].then( () => { return this._singleSQL(client, sql[i], db) });
        }

        // Disconnect client in a final then block;
        pro[pro.length] = pro[pro.length-1].then((result) => { client.end(); return result; });

        // Add a catch block to capture exceptions, cleanly disconnect and return error object as rejected.
        return pro[pro.length-1].catch((err) => {
            client.end();
            return Promise.reject(err);
        });
    }

    /**
     * Executes sql script file on a given database.
     * @param {string} file     - Path of the SQL file to be executed.
     * @param {string} [db]     - Database name. Uses default value from configuration if no value is given.
     * @returns {Promise}
     */
    executeSQLFile(file, db) {
        let sql = fs.readFileSync(file).toString().trim();
        return this.executeSQL(sql, db);
    }

    /**
     * Creates a new db with given name from PostgreSQL template database.
     * @param {string}      db                              - Name of the database which will be created.
     * @param {Object}      [options]
     * @param {string}      [options.template=template0]    - PostgreSQL Template database to create new db from.
     * @param {string}      [options.encoding=UTF8]         - Encoding of the created database.
     * @param {boolean}     [options.drop=false]            - Drop database if exists.
     * @returns {Promise}
     */
    createDB(db, options) {
        let config      = options || {},
            encoding    = config.encoding || 'UTF8',
            template    = config.template || 'template0',
            drop        = config.drop || false,
            sql = `CREATE DATABASE "${db}" WITH ENCODING = '${encoding}' TEMPLATE = "${template}";`;

        if (drop) {
            return this.dropDB(db)
                .then( () => { return this.executeSQL(sql, this.dbConfig.connectionDatabase); } );

        } else {
            return this.executeSQL(sql, this.dbConfig.connectionDatabase);
        }
    }


    /**
     * Drops given database. If there are other connected clients to this databse, also drops their connections
     * to prevent this error from PostgreSQL: database "..." is being accessed by other users.
     * @param {string}      db          - Name of the database which will be created.
     * @return {Promise}
     */
    dropDB(db) {
        let sql = [
            `SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname='${db}';`,
            `DROP DATABASE IF EXISTS "${db}";`
        ];
        return this.executeSQL(sql, this.dbConfig.connectionDatabase);
    }
}

module.exports = PgTestUtil;

</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a> on Thu Oct 29 2015 13:05:54 GMT+0200 (EET)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
