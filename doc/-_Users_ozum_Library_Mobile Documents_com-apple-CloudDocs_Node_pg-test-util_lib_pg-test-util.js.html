<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: /Users/ozum/Library/Mobile Documents/com~apple~CloudDocs/Node/pg-test-util/lib/pg-test-util.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"PostgreSQL Test Utilities","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">PostgreSQL Test Utilities</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="PgTestUtil">
            <span class="title">
                <a href="PgTestUtil.html">PgTestUtil</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="PgTestUtil#createDB"><a href="PgTestUtil.html#createDB">createDB</a></li>
            
                <li data-name="PgTestUtil#dropDB"><a href="PgTestUtil.html#dropDB">dropDB</a></li>
            
                <li data-name="PgTestUtil#executeSQL"><a href="PgTestUtil.html#executeSQL">executeSQL</a></li>
            
                <li data-name="PgTestUtil#executeSQLFile"><a href="PgTestUtil.html#executeSQLFile">executeSQLFile</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="-_Users_ozum_Library_Mobile Documents_com-apple-CloudDocs_Node_pg-test-util_lib_pg-test-util.js.html">Source: /Users/ozum/Library/Mobile Documents/com~apple~CloudDocs/Node/pg-test-util/lib/pg-test-util.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>'use strict';
var optional    = require('optional');
var pgNative    = optional('pg-native');
var pg          = pgNative ? require('pg').native : require('pg');
var fs          = require('fs');
var path        = require('path');
var lodash      = require('lodash');

var sql = {
    dropConnection: function(db) { return `SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname='${db}';`; },

    dropDB: function(db) { return `DROP DATABASE IF EXISTS "${db}";`; },

    createDB: function(db, encoding, template) { return `CREATE DATABASE "${db}" WITH ENCODING = '${encoding}' TEMPLATE = "${template}";`; }

};

/**
 * Helper class and methods to use in tests using PostgreSQL database. Primary focus of this class is not speed.
 * First priority is given to do operations such as create database, drop database etc. As a result this class
 * connects to database, runs query and then simply disconnects for every query in an inefficient way to prevent
 * further tests stopped by connection or access by others errors.
 *
 * PostgreSQL needs a database name for every connection, even for creating a new database, user have to connect
 * another database. This library accepts "connectionDatabase" parameter for the name of this database for creating
 * and/or dropping databases.
 *
 * It may not best method, but it is suggested to use credentials of a PostgreSQL user which has database create
 * and drop privileges and connect to "template1" database.
 *
 * @example
 * var PgTestUtil = require('pg-test-util');
 * var pgUtil = new PgTestUtil({
 *     user             : 'user',
 *     password         : 'password',
 *     defaultDatabase  : 'db-name'
 * });
 *
 * // Using function in promises
 *
 * pgUtil.createDB('testdb', { drop: true })
 * .then(function() { return pgUtil.createDB('testdb2', { drop: true }) })
 * .then(function() { return pgUtil.dropDB('testdb') })
 * .catch(function(err) { console.log(err); });
 */
class PgTestUtil {
    /**
     * @param {Object}  [dbConfig]                                  - Configuration parameters.
     * @param {string}  [dbConfig.user=postgres]                    - User name
     * @param {string}  [dbConfig.password]                         - DB Password
     * @param {string}  [dbConfig.host=localhost]                   - Host name
     * @param {number}  [dbConfig.port=5432]                        - Port number
     * @param {string}  [dbConfig.defaultDatabase]                  - Default database name to connect fro queries if no db is given.
     * @param {string}  [dbConfig.connectionDatabase=template1]     - Database name to connect to execute createDB and dropDB functions.
     *                                                                Every connection needs a database to connect even for creating a new database.
     */
    constructor(dbConfig) {
        this.dbConfig                       = {};
        this.dbConfig.user                  = dbConfig.user     || 'postgres';
        this.dbConfig.password              = dbConfig.password;
        this.dbConfig.host                  = dbConfig.host     || 'localhost';
        this.dbConfig.port                  = dbConfig.port     || 5432;
        this.dbConfig.defaultDatabase       = dbConfig.defaultDatabase;
        this.dbConfig.connectionDatabase    = dbConfig.connectionDatabase || 'template1';
    }

    /**
     * Executes single SQL. If result is successful calls success callback, if
     * result is failure calls fail callback.
     * @param {pg.Client}   client                      - PG client object to execute SQL
     * @param {string}      sql                         - SQL query to execute
     * @returns {Promise}
     * @private
     */
    _singleSQL(client, sql) {
        return new Promise((resolve, reject) => {
            client.query(sql, function(err, result) {
                if (err) return reject(new Error(err));
                resolve(result);
            });
        });
    }

    _connect(client) {
        return new Promise((resolve, reject) => {
            client.connect((err) => {
                if (err) return reject(new Error(err));
                resolve();
            });
        });
    }

    /**
     * Connects to database, executes a single SQL query or a series of SQL queries against given databse,
     * then disconnects from it.
     * @param {string|Array.&lt;string>}   sql     - SQL query or array of SQL queries to execute.
     * @param {string}                  [db]    - Database name to query against. Uses default value from configuration if no value is given.
     * @returns {Promise.&lt;T>}
     */
    executeSQL(sql, db) {
        db = db || this.dbConfig.defaultDatabase;
        if (!db) throw new Error('db parameter for database name is required.');

        let client  = new pg.Client(lodash.defaults({ database: db }, this.dbConfig));

        if (typeof sql === 'string') sql = [sql]; // Convert SQL into array if it is a string.

        let promise = sql.reduce((prev, current) => {
            return prev.then(() => { return this._singleSQL(client, current); });
        }, this._connect(client));

        promise = promise
            .then((result) => {
                client.end(); return result;
            })
            .catch((err) => {
                client.end(); return Promise.reject(err);
            });

        return promise;
    }

    /**
     * Executes sql script file on a given database.
     * @param {string}  file                        - Path of the SQL file to be executed.
     * @param {string}  [db]                        - Database name. Uses default value from configuration if no value is given.
     * @param {Object}  [options]                   - Execution options.
     * @param {boolean} [options.disableTriggers]   - Disables all triggers and foreign key checks. Useful for loading backup/replicated date.
     * @returns {Promise}
     */
    executeSQLFile(file, db, options) {
        let sql = fs.readFileSync(file).toString().trim();

        if (options &amp;&amp; options.disableTriggers) {
            sql = 'SET session_replication_role = replica;\n\n' + sql + '\n\n SET session_replication_role = DEFAULT;\n';
        }

        return this.executeSQL(sql, db);
    }

    /**
     * Creates a new db with given name from PostgreSQL template database.
     * @param {string}      db                              - Name of the database which will be created.
     * @param {Object}      [options]
     * @param {string}      [options.template=template0]    - PostgreSQL Template database to create new db from.
     * @param {string}      [options.encoding=UTF8]         - Encoding of the created database.
     * @param {boolean}     [options.drop=false]            - Drop database if exists.
     * @returns {Promise}
     */
    createDB(db, options) {
        let config      = options || {};
        let encoding    = config.encoding || 'UTF8';
        let template    = config.template || 'template0';
        let drop        = config.drop || false;
        let queries     = [];

        if (drop) {
            queries.push(sql.dropConnection(db));
            queries.push(sql.dropDB(db));
        }

        queries.push(sql.createDB(db, encoding, template));

        return this.executeSQL(queries, this.dbConfig.connectionDatabase);
    }

    /**
     * Drops given database. If there are other connected clients to this databse, also drops their connections
     * to prevent this error from PostgreSQL: database "..." is being accessed by other users.
     * @param {string}      db          - Name of the database which will be created.
     * @return {Promise}
     */
    dropDB(db) {
        let queries = [
            sql.dropConnection(db),
            sql.dropDB(db)
        ];
        return this.executeSQL(queries, this.dbConfig.connectionDatabase);
    }
}

module.exports = PgTestUtil;
</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Jun 06 2016 14:24:04 GMT+0300 (EEST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
